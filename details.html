<!DOCTYPE html>
<html>
<head>
  <title>Medicine Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, button { padding: 10px; width: 100%; max-width: 400px; margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>Medicine Details</h2>
<div id="info"></div>

<h3>Update Stock</h3>
<label>Stock Used: <input type="number" id="used"></label>
<label>Stock Bought: <input type="number" id="bought"></label>
<label>Date of Buying: <input type="date" id="buyDate"></label>
<button onclick="updateStock()">Update</button>

<script>
  const API = "https://script.google.com/macros/s/AKfycbyOlISL9ijvtRuSilhF1h_hJZwBFkWVeW5ac2sEhN8oBtHZyNU4LOzXiBhkj0lGO34rCw/exec";
  const params = new URLSearchParams(window.location.search);
  const medName = params.get("name");

  let current;

  async function loadDetails() {
    const res = await fetch(API);
    const meds = await res.json();
    current = meds.find(m => m.name === medName);
    if (!current) {
      document.getElementById("info").innerText = "Medicine not found.";
      return;
    }

    document.getElementById("info").innerHTML = `
      <p><strong>Name:</strong> ${current.name}</p>
      <p><strong>Initial Stock:</strong> ${current.initial}</p>
      <p><strong>Units Sold:</strong> ${current.sold}</p>
      <p><strong>Remaining:</strong> ${current.initial - current.sold}</p>
      <p><strong>Reorder Level:</strong> ${current.reorder}</p>
      <p><strong>Status:</strong> ${current.initial - current.sold <= current.reorder ? "LOW STOCK" : "OK"}</p>
      <p><strong>Last Bought:</strong> ${current.lastBought || "-"}</p>
    `;
  }

  async function updateStock() {
    const used = parseInt(document.getElementById("used").value) || 0;
    const bought = parseInt(document.getElementById("bought").value) || 0;
    const buyDate = document.getElementById("buyDate").value;

    const newInitial = current.initial + bought;
    const newSold = current.sold + used;

    const data = {
      name: current.name,
      initial: newInitial,
      sold: newSold,
      reorder: current.reorder,
      lastBought: buyDate || current.lastBought
    };

    await fetch(API, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });

    alert("Updated!");
    window.location.href = "index.html";
  }

  loadDetails();
</script>

</body>
</html>
